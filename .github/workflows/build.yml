name: Build and Package

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main", "master" ]

jobs:
  frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install and Build Frontend
      run: |
        cd frontend
        npm install
        npm run build
        
    - name: Upload Frontend Artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist

  build-desktop:
    name: Build Desktop (${{ matrix.os }})
    needs: frontend
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Download Frontend Artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Linux System Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          gir1.2-webkit2-4.1 \
          python3-dev \
           libcairo2-dev \
           libgirepository1.0-dev \
           libgirepository-2.0-dev \
           pkg-config

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ./backend[dev]
        pip install pyinstaller

    - name: Create Source Package (Linux Only)
      if: runner.os == 'Linux'
      run: |
        python scripts/build.py --type source --skip-frontend
        ls -R dist

    - name: Build Application
      run: python scripts/build.py --type exe --skip-frontend --mode desktop

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: WaveGauge-${{ runner.os }}
        path: dist/WaveGauge-*.zip
        if-no-files-found: error

  build-server-centos:
    name: Build Server (CentOS 7)
    needs: frontend
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Download Frontend Artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist

    - name: Build in Manylinux Container
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          quay.io/pypa/manylinux2014_x86_64 \
          bash -c "yum install -y gcc && export PATH=/opt/python/cp311-cp311/bin:\$PATH && export LD_LIBRARY_PATH=/opt/python/cp311-cp311/lib:\$LD_LIBRARY_PATH && pip install --upgrade pip && pip install ./backend && pip install pyinstaller && python scripts/build.py --type exe --skip-frontend --mode server && chown -R \$(id -u):\$(id -g) dist"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: WaveGauge-CentOS7-Server
        path: dist/WaveGauge-Server-*.zip
        if-no-files-found: error

  release:
    name: Create Release
    needs: [build-desktop, build-server-centos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: ls -R artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/WaveGauge-Linux/WaveGauge-*.zip
          artifacts/WaveGauge-Windows/WaveGauge-*.zip
          artifacts/WaveGauge-CentOS7-Server/WaveGauge-Server-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
